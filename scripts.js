const preguntas = {
    musica: [
        {
            pregunta: "¬øQui√©n es considerado el m√°ximo exponente de la m√∫sica tradicional cuencana?",
            opciones: ["Gerardo Guevara", "Segundo Bautista", "Carlos Rubira Infante", "Nicasio Safadi"],
            respuesta: 1
        },
        {
            pregunta: "¬øCu√°l es el nombre del tradicional g√©nero musical cuencano interpretado con rondadores y guitarras?",
            opciones: ["Sanjuanito", "Albazo", "Pasillo", "Yarav√≠"],
            respuesta: 2
        },
        {
            pregunta: "¬øCu√°l de estos artistas ha interpretado la canci√≥n ‚ÄúChola Cuencana‚Äù?",
            opciones: ["Paulina Tamayo", "Julio Jaramillo", "Pepe Jaramillo", "Margarita Laso"],
            respuesta: 0
        },
        {
            pregunta: "¬øQu√© instrumento andino es t√≠pico en la m√∫sica tradicional cuencana?",
            opciones: ["Quena", "Rondador", "Zampo√±a", "Charango"],
            respuesta: 1
        },
        {
            pregunta: "¬øCu√°l es el festival musical m√°s representativo de Cuenca?",
            opciones: ["Festival de la Luz", "Festival de M√∫sica Sacra", "Festival de la Lira", "Festival de Jazz"],
            respuesta: 1
        },
        {
            pregunta: "¬øQui√©n compuso la famosa canci√≥n ‚ÄúVasija de Barro‚Äù, tan interpretada en Cuenca?",
            opciones: ["Gonzalo Ben√≠tez", "Benjam√≠n Carri√≥n", "Gonzalo Llona", "Jorge Carrera Andrade"],
            respuesta: 3
        },
        {
            pregunta: "¬øEn qu√© mes se realiza tradicionalmente el Festival Internacional de la Cultura en Cuenca?",
            opciones: ["Febrero", "Abril", "Noviembre", "Agosto"],
            respuesta: 2
        },
        {
            pregunta: "¬øCu√°l es un g√©nero musical que se escucha en las fiestas de Cuenca?",
            opciones: ["Marinera", "Danzante", "Cumbia", "Tango"],
            respuesta: 2
        },
        {
            pregunta: "¬øQu√© canci√≥n es considerada un himno no oficial de Cuenca?",
            opciones: ["Linda Cuenca", "Chola Cuencana", "Vasija de Barro", "El Aguacate"],
            respuesta: 1
        },
        {
            pregunta: "¬øQu√© agrupaci√≥n cuencana ha representado a la ciudad en el exterior?",
            opciones: ["Tr√≠o Colonial", "Los Trovadores", "Los Hermanos Mi√±o Naranjo", "D√∫o Ben√≠tez-Valencia"],
            respuesta: 1
        }
    ],
    comida: [
        {
            pregunta: "¬øCu√°l es el plato t√≠pico por excelencia en Cuenca durante el Carnaval?",
            opciones: ["Hornado", "Fanesca", "Mote Pata", "Encebollado"],
            respuesta: 2
        },
        {
            pregunta: "¬øCu√°l de estos ingredientes es indispensable en el ‚Äúmote pillo‚Äù?",
            opciones: ["Pollo", "Huevo", "Carne de res", "Pescado"],
            respuesta: 1
        },
        {
            pregunta: "¬øCu√°l es el postre tradicional de Cuenca preparado con higos?",
            opciones: ["Higos con queso", "Dulce de higos", "Helado de paila", "Queso de hoja"],
            respuesta: 1
        },
        {
            pregunta: "¬øC√≥mo se llama la bebida de ma√≠z fermentado t√≠pica de Cuenca?",
            opciones: ["Chicha", "Canelazo", "Colada morada", "Morocho"],
            respuesta: 0
        },
        {
            pregunta: "¬øQu√© tipo de pan es famoso en Cuenca y se suele comer en la merienda?",
            opciones: ["Pan de yuca", "Pan de agua", "Pan de cebada", "Pan de trigo"],
            respuesta: 1
        },
        {
            pregunta: "¬øCu√°l de estos platos es una sopa tradicional de Cuenca?",
            opciones: ["Locro", "Mote sucio", "Encebollado", "Caldo de patas"],
            respuesta: 3
        },
        {
            pregunta: "¬øQu√© alimento acompa√±a siempre al ‚Äúhornado‚Äù cuencano?",
            opciones: ["Choclo", "Mote", "Yuca", "Arroz"],
            respuesta: 1
        },
        {
            pregunta: "¬øC√≥mo se llama el bocadillo de dulce t√≠pico de Cuenca preparado con leche y az√∫car?",
            opciones: ["Natilla", "Turr√≥n", "Rosquillas", "Queso de hoja"],
            respuesta: 0
        },
        {
            pregunta: "¬øCu√°l es el platillo preparado con sangre de cerdo, arroz y especias?",
            opciones: ["Chorizo", "Morcilla", "Salchicha", "Seco"],
            respuesta: 1
        },
        {
            pregunta: "¬øQu√© fruta es t√≠pica en los mercados de Cuenca durante la temporada de Corpus Christi?",
            opciones: ["Frutilla", "Capul√≠", "Granadilla", "Mango"],
            respuesta: 1
        }
    ],
    arte: [
        {
            pregunta: "¬øEn qu√© museo de Cuenca se encuentra la famosa ‚ÄúVasija de Barro‚Äù?",
            opciones: ["Museo Remigio Crespo", "Museo Pumapungo", "Museo de Arte Moderno", "Museo de las Conceptas"],
            respuesta: 1
        },
        {
            pregunta: "¬øCu√°l es la t√©cnica artesanal famosa en Cuenca y reconocida por la UNESCO?",
            opciones: ["Cer√°mica", "Sombrero de paja toquilla", "Bordado", "Orfebrer√≠a"],
            respuesta: 1
        },
        {
            pregunta: "¬øQu√© artista cuencano es conocido por su obra en acuarela y paisajismo?",
            opciones: ["Oswaldo Guayasam√≠n", "Eduardo Segovia", "Hern√°n Illescas", "Enrique T√°bara"],
            respuesta: 2
        },
        {
            pregunta: "¬øQu√© color predomina en las fachadas coloniales del centro hist√≥rico de Cuenca?",
            opciones: ["Azul", "Amarillo", "Blanco", "Verde"],
            respuesta: 2
        },
        {
            pregunta: "¬øQu√© evento art√≠stico se realiza en noviembre con instalaciones en toda la ciudad?",
            opciones: ["Bienal de Cuenca", "Fiesta de la Mama Negra", "Carnaval de las Flores", "Festival Internacional de Danza"],
            respuesta: 0
        },
        {
            pregunta: "¬øQu√© escultura es caracter√≠stica de la Plaza San Sebasti√°n?",
            opciones: ["√Ångel de la Paz", "El Perro Callejero", "El Monumento a la Chola Cuencana", "Fuente de los Leones"],
            respuesta: 3
        },
        {
            pregunta: "¬øCu√°l es el principal teatro de la ciudad?",
            opciones: ["Teatro Sucre", "Teatro CCE", "Teatro Bol√≠var", "Teatro Pumapungo"],
            respuesta: 2
        },
        {
            pregunta: "¬øQu√© pintor cuencano realiz√≥ murales en la Catedral Nueva?",
            opciones: ["Eduardo Segovia", "Miguel Illescas", "Humberto Mor√©", "Jaime Andrade"],
            respuesta: 2
        },
        {
            pregunta: "¬øCu√°l es una artesan√≠a t√≠pica de Cuenca aparte del sombrero de paja toquilla?",
            opciones: ["Juguetes de madera", "Orfebrer√≠a de plata", "Tapices", "Tallado en piedra"],
            respuesta: 1
        },
        {
            pregunta: "¬øD√≥nde se exhibe la Bienal de Arte de Cuenca?",
            opciones: ["Museo de las Conceptas", "Antiguo Hospital Militar", "Casa de la Cultura", "Diferentes espacios p√∫blicos y privados"],
            respuesta: 3
        }
    ],
    cultura: [
        {
            pregunta: "¬øEn qu√© a√±o fue declarada Cuenca Patrimonio Cultural de la Humanidad por la UNESCO?",
            opciones: ["1989", "1999", "2002", "2012"],
            respuesta: 1
        },
        {
            pregunta: "¬øC√≥mo se llama el r√≠o m√°s largo que cruza Cuenca?",
            opciones: ["Tomebamba", "Yanuncay", "Tarqui", "Mach√°ngara"],
            respuesta: 0
        },
        {
            pregunta: "¬øCu√°l es el nombre oficial de la catedral m√°s grande de Cuenca?",
            opciones: ["Catedral Nueva", "Catedral de la Inmaculada Concepci√≥n", "Catedral Vieja", "Bas√≠lica del Voto Nacional"],
            respuesta: 1
        },
        {
            pregunta: "¬øCu√°ntos r√≠os principales atraviesan la ciudad de Cuenca?",
            opciones: ["Dos", "Tres", "Cuatro", "Cinco"],
            respuesta: 2
        },
        {
            pregunta: "¬øC√≥mo se llama la fiesta tradicional m√°s importante en noviembre?",
            opciones: ["Semana Santa", "Carnaval", "Fiestas de Fundaci√≥n", "Fiestas de Independencia"],
            respuesta: 3
        },
        {
            pregunta: "¬øQu√© universidad es la m√°s antigua de Cuenca?",
            opciones: ["Universidad Cat√≥lica", "Universidad de Cuenca", "Universidad Polit√©cnica Salesiana", "Universidad del Azuay"],
            respuesta: 1
        },
        {
            pregunta: "¬øQu√© famoso parque es conocido por sus lagunas en Cuenca?",
            opciones: ["Parque Nacional Podocarpus", "Parque Nacional Cajas", "Parque Calder√≥n", "Parque El Para√≠so"],
            respuesta: 1
        },
        {
            pregunta: "¬øC√≥mo se llama el mercado m√°s antiguo de Cuenca?",
            opciones: ["Mercado 9 de Octubre", "Mercado 10 de Agosto", "Mercado 27 de Febrero", "Mercado 3 de Noviembre"],
            respuesta: 1
        },
        {
            pregunta: "¬øCu√°l es la principal actividad econ√≥mica tradicional de Cuenca?",
            opciones: ["Miner√≠a", "Agricultura", "Artesan√≠a", "Pesca"],
            respuesta: 2
        },
        {
            pregunta: "¬øCu√°l es el apodo de la ciudad de Cuenca?",
            opciones: ["La Atenas del Ecuador", "La Sultana de los Andes", "La Perla del Pac√≠fico", "La Tierra del Sol"],
            respuesta: 0
        }
    ]
};
// (Elimina esta declaraci√≥n duplicada de preguntas)

// ==== Variables globales ====
const audioCorrect = new Audio('mp3/correct.mp3');
audioCorrect.volume = 0.5;
const audioWrong = new Audio('mp3/incorrect.mp3');
audioWrong.volume = 0.1;
const audioBg = new Audio('mp3/oriental.mp3');
audioBg.loop = true;
audioBg.volume = 0.5;

let currentCategory = "", currentIndex = 0, score = 0, timer = null, timeLeft = 30;
let saltoUsado = false, respuestas = [];
let avanceTimeout = null;
let musicOn = true;

const startScreen = document.getElementById('start-screen');
const quizScreen = document.getElementById('quiz-screen');
const resultScreen = document.getElementById('result-screen');
const quizCategory = document.getElementById('quiz-category');
const quizProgress = document.getElementById('quiz-progress');
const progressBar = document.getElementById('progress-bar');
const quizImage = document.getElementById('quiz-image');
const musicBtn = document.getElementById('music-btn');
const scoreCurrent = document.getElementById('score-current');
const quizTimer = document.getElementById('quiz-timer');
const quizQuestion = document.getElementById('quiz-question');
const quizOptions = document.getElementById('quiz-options');
const nextBtn = document.getElementById('next-btn');
const skipBtn = document.getElementById('skip-btn');
const finalScore = document.getElementById('final-score');
const homeBtn = document.getElementById('home-btn');
const exitBtn = document.getElementById('exit-btn');
const downloadBtn = document.getElementById('download-image');
const shareButtons = document.getElementById('share-buttons');
const shareWhatsapp = document.getElementById('share-whatsapp');
const shareInstagram = document.getElementById('share-Instagram');
const copyResultBtn = document.getElementById('copy-result');

const categoryImages = {
    musica: 'img/logo.png',
    comida: 'img/logo.png',
    arte: 'img/logo.png',
    cultura: 'img/logo.png'
};

function mezclarArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}


function showSection(section) {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    section.classList.add('active');
    nextBtn.classList.add('hidden');
    clearInterval(timer);
    clearTimeout(avanceTimeout);
    quizTimer.textContent = "";

    if (section === startScreen) {
        audioBg.play().catch(() => {});
        document.body.style.backgroundImage = 'url(img/fondo-inicio.jpg)';
    } else {
        audioBg.pause();
        audioBg.currentTime = 0;
    }
}

function setTheme() {
    document.body.classList.remove('tema-musica', 'tema-comida', 'tema-arte', 'tema-cultura');
    document.body.classList.add('tema-' + currentCategory);
}

function updateProgressBar() {
    const percent = ((currentIndex + 1) / preguntas[currentCategory].length) * 100;
    progressBar.style.width = percent + '%';
}

function fadeInPregunta() {
    quizQuestion.classList.add('fade-enter');
    setTimeout(() => {
        quizQuestion.classList.add('fade-enter-active');
        setTimeout(() => quizQuestion.classList.remove('fade-enter', 'fade-enter-active'), 600);
    }, 10);
}

function mostrarPregunta() {
    clearInterval(timer);
    clearTimeout(avanceTimeout);
    timeLeft = 30;
    quizOptions.innerHTML = "";
    nextBtn.classList.add('hidden');
    quizTimer.textContent = `‚è∞ ${timeLeft}s`;
    setTheme();
    updateProgressBar();
    fadeInPregunta();
    skipBtn.classList.remove('hidden');
    skipBtn.disabled = saltoUsado;
    quizImage.src = categoryImages[currentCategory];
    scoreCurrent.innerHTML = `Puntaje: ${score} / ${preguntas[currentCategory].length}`;

    const preguntaObj = preguntas[currentCategory][currentIndex];
    quizCategory.textContent = {
        musica: 'M√∫sica üé∂',
        comida: 'Comida üç≤',
        arte: 'Arte üé®',
        cultura: 'Cultura General üåé'
    }[currentCategory];
    quizProgress.textContent = `${currentIndex + 1}/${preguntas[currentCategory].length}`;
    quizQuestion.textContent = preguntaObj.pregunta;

    preguntaObj.opciones.forEach((opcion, idx) => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.textContent = opcion;
        btn.disabled = false;
        btn.classList.remove('correct', 'incorrect', 'disabled');
        btn.addEventListener('click', () => seleccionarRespuesta(btn, idx, true));
        quizOptions.appendChild(btn);
    });

    respuestas[currentIndex] = null;

    timer = setInterval(() => {
        timeLeft--;
        quizTimer.textContent = `‚è∞ ${timeLeft}s`;
        if (timeLeft <= 0) {
            clearInterval(timer);
            seleccionarRespuesta(null, preguntaObj.respuesta, false);
        }
    }, 1000);
}

function seleccionarRespuesta(btn, idx, userClicked = true) {
    clearInterval(timer);
    clearTimeout(avanceTimeout);

    const preguntaObj = preguntas[currentCategory][currentIndex];
    const correcta = preguntaObj.respuesta;

    document.querySelectorAll('.option-btn').forEach((b, i) => {
        b.disabled = true;
        b.classList.add('disabled');
        if (i === correcta) b.classList.add('correct');
        if (userClicked && i === idx && idx !== correcta) b.classList.add('incorrect');
    });

    if (userClicked) {
        respuestas[currentIndex] = { esc: idx, correcto: idx === correcta };
        if (idx === correcta) {
            audioCorrect.currentTime = 0;
            audioCorrect.play();
            score++;
        } else {
            audioWrong.currentTime = 0;
            audioWrong.play();
        }
    } else {
        respuestas[currentIndex] = { esc: null, correcto: false };
        audioWrong.currentTime = 0;
        audioWrong.play();
    }

    scoreCurrent.innerHTML = `Puntaje: ${score} / ${preguntas[currentCategory].length}`;
    nextBtn.classList.remove('hidden');
    skipBtn.classList.add('hidden');

    avanceTimeout = setTimeout(() => {
        currentIndex++;
        if (currentIndex < preguntas[currentCategory].length) {
            mostrarPregunta();
        } else {
            mostrarResultado();
        }
    }, 3000);
}

function mostrarResultado() {
    showSection(resultScreen);
    clearInterval(timer);

    const total = preguntas[currentCategory].length;
    finalScore.innerHTML = `
        <b>${score}</b> de <b>${total}</b> puntos.<br><br>
        <button onclick="mostrarRespuestas()">Ver Respuestas</button><br><br>
        ${score === total ? '¬°Eres un/a crack cuencano/a!' : '¬°Intenta mejorar tu puntaje!'}
    `;

    document.getElementById('screenshot-category').textContent = {
        musica: 'M√∫sica üé∂',
        comida: 'Comida üç≤',
        arte: 'Arte üé®',
        cultura: 'Cultura General üåé'
    }[currentCategory];
    document.getElementById('screenshot-score').textContent = `${score} / ${total}`;

    downloadBtn.onclick = () => {
        const area = document.getElementById('screenshot-card');
        html2canvas(area).then(canvas => {
            const link = document.createElement('a');
            link.download = 'resultado-quiz-cuenca.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    };

    shareButtons.classList.remove('hidden');
    const url = encodeURIComponent(window.location.href);
    const texto = encodeURIComponent(`¬°Acabo de jugar el Quiz de Cuenca y obtuve ${score} de ${total} puntos! ¬øPuedes superarme?`);

    shareWhatsapp.onclick = () => {
        window.open(`https://api.whatsapp.com/send?text=${texto}%20${url}`, '_blank');
    };

    shareInstagram.onclick = () => {
        window.open(`https://twitter.com/intent/tweet?text=${texto}&url=${url}`, '_blank');
    };

    copyResultBtn.onclick = () => {
        const copyText = `¬°Acabo de jugar el Quiz de Cuenca y obtuve ${score} de ${total} puntos! Pru√©balo t√∫ tambi√©n: ${window.location.href}`;
        navigator.clipboard.writeText(copyText)
            .then(() => alert('Resultado copiado al portapapeles ‚úÖ'))
            .catch(() => alert('No se pudo copiar el resultado ‚ùå'));
    };
}

function reiniciar() {
    currentIndex = 0;
    score = 0;
    saltoUsado = false;
    respuestas = [];
    showSection(startScreen);
}

if (musicBtn) {
    musicBtn.onclick = () => {
        musicOn = !musicOn;
        if (musicOn) {
            audioBg.play().catch(() => {});
            musicBtn.classList.remove('fa-volume-xmark');
            musicBtn.classList.add('fa-volume-high');
        } else {
            audioBg.pause();
            musicBtn.classList.remove('fa-volume-high');
            musicBtn.classList.add('fa-volume-xmark');
        }
    };
}

if (homeBtn) {
    homeBtn.addEventListener('click', () => reiniciar());
}

if (exitBtn) {
    exitBtn.addEventListener('click', () => {
        if (confirm('¬øDeseas salir del quiz?')) reiniciar();
    });
}

document.querySelectorAll('.category-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        currentCategory = btn.dataset.category;
        if (!preguntas[currentCategory]) return;
        mezclarArray(preguntas[currentCategory]);
        currentIndex = 0;
        score = 0;
        saltoUsado = false;
        respuestas = [];
        showSection(quizScreen);
        document.body.style.backgroundImage = `url(img/fondo-${currentCategory}.jpg)`;
        mostrarPregunta();
    });
});

nextBtn.addEventListener('click', () => {
    currentIndex++;
    if (currentIndex < preguntas[currentCategory].length) {
        mostrarPregunta();
    } else {
        mostrarResultado();
    }
});

skipBtn.addEventListener('click', () => {
    saltoUsado = true;
    skipBtn.disabled = true;
    skipBtn.classList.add('hidden');
    clearInterval(timer);
    clearTimeout(avanceTimeout);
    seleccionarRespuesta(null, preguntas[currentCategory][currentIndex].respuesta, false);
});

showSection(startScreen);
showSection(startScreen);
